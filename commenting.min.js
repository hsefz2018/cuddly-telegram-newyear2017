!function(t){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var i=function(e){return this instanceof i?(e=e||{},e.width=e.width||t.innerWidth||1080,e.height=e.height||t.innerHeight||720,e.lineHeight=e.lineHeight||void 0,e.fontSize=e.fontSize||void 0,e.removeCallback=e.removeCallback||void 0,e.timeoutCallback=e.timeoutCallback||void 0,this.opt=e,this._rowTSpareR=[],this._rowTSpareL=[],this._rowBSpare=[],this._bulletsT=[],this._bulletsB=[],this._showT=!0,this._showB=!0,this._selBullet=null,this.sayHello(),void this.initEl()):new i(e)};i.prototype.sayHello=function(){console.log("Hello from Cuddly Telegram")},i.prototype.initEl=function(){this._el=t.document.createElement("div"),this._el.style.position="absolute",this._el.style.left="0px",this._el.style.top="0px",this._el.style.pointerEvents="none",this._el.style.background="none",this._el.style.overflow="hidden",this._el.style.transition="width 500ms cubic-bezier(0.215, 0.610, 0.355, 1), height 200ms cubic-bezier(0.215, 0.610, 0.355, 1)",this.updateSize()},i.prototype.getEl=function(){return this._el},i.prototype.getLineHeight=function(){return this.opt.lineHeight||1.2*this.opt.height/24},i.prototype.updateSize=function(t,e){this.opt.width=t||this.opt.width,this.opt.height=e||this.opt.height,this._el.style.width=this.opt.width.toString()+"px",this._el.style.height=this.opt.height.toString()+"px";for(var n=Math.floor(this.opt.height/this.getLineHeight());this._rowTSpareR.length<n;)this._rowTSpareR.push(-1);for(;this._rowTSpareL.length<n;)this._rowTSpareL.push(-1);for(;this._rowBSpare.length<n;)this._rowBSpare.push(-1);for(;this._rowTSpareR.length>n;)this._rowTSpareR.pop();for(;this._rowTSpareL.length>n;)this._rowTSpareL.pop();for(;this._rowBSpare.length>n;)this._rowBSpare.pop()},i.prototype.createBullet=function(e,n,o,i){var l=t.document.createElement("div");return this._el.appendChild(l),l._cmtID=e,l.style.fontSize=this.opt.fontSize||Math.round(this.opt.height/24).toString()+"px",l.style.color=o||"white",l.style.width="auto",l.style.whiteSpace="nowrap",l.textContent=n,l.style.position="absolute",l.style.pointerEvents="none",l.style.opacity=i?1:0,l.style.transition="opacity 0.15s linear, background-color 0.15s linear",l},i.prototype.emitTop=function(t,e,n){for(var o=this.createBullet(t,e,n,this._showT),i=Date.now(),l=this.opt.width,r=this.opt.width+o.clientWidth,s=1e4,a=r/s,u=i+o.clientWidth/a,p=i+l/a,c=i+s,h=-1,d=0;d<this._rowTSpareL.length;++d)if(this._rowTSpareR[d]<i&&this._rowTSpareL[d]<p){h=d;break}if(h==-1){h=0;for(var d=1;d<this._rowTSpareL.length;++d)this._rowTSpareL[d]<this._rowTSpareL[h]&&(h=d)}this._rowTSpareR[h]=u,this._rowTSpareL[h]=c,o.style.transition+=", left "+Math.round(s/1e3).toString()+"s linear",o.style.left=Math.round(l).toString()+"px",o.style.top=Math.round(h*this.getLineHeight()+6).toString()+"px",o._arrId=this._bulletsT.push(o)-1,o._cancelled=!1,setTimeout(function(t,e){return function(){t.style.left=e.toString()+"px"}}(o,-o.clientWidth),25);var f=function(t){return function(e){"left"===e.propertyName&&(t._bulletsT[e.target._arrId]=t._bulletsT[t._bulletsT.length-1],t._bulletsT[e.target._arrId]._arrId=e.target._arrId,t._bulletsT.pop(),e.target.parentNode.removeChild(e.target),e.target._cancelled||"function"!=typeof t.opt.timeoutCallback||t.opt.timeoutCallback(e.target._cmtID))}}(this);o.addEventListener("transitionend",f),o.addEventListener("webkitTransitionend",f)},i.prototype.emitBottom=function(t,e,n){for(var o=this.createBullet(t,e,n,this._showB),i=Date.now(),l=(this.opt.width-o.clientWidth)/2,r=5e3,s=i+r,a=-1,u=0;u<this._rowBSpare.length;++u)if(this._rowBSpare[u]<i){a=u;break}if(a==-1){a=0;for(var u=1;u<this._rowBSpare.length;++u)this._rowBSpare[u]<this._rowBSpare[a]&&(a=u)}this._rowBSpare[a]=s,o.style.left=Math.round(l).toString()+"px",o.style.top="",o.style.bottom=Math.round(a*this.getLineHeight()+6).toString()+"px",o._arrId=this._bulletsB.push(o)-1,o._cancelled=!1,setTimeout(function(t,e){return function(){t._bulletsB[e._arrId]=t._bulletsB[t._bulletsB.length-1],t._bulletsB[e._arrId]._arrId=e._arrId,t._bulletsB.pop(),e.parentNode.removeChild(e),e._cancelled||"function"!=typeof t.opt.timeoutCallback||t.opt.timeoutCallback(e._cmtID)}}(this,o),r)},i.prototype.updateTopDisp=function(t){this._showT=t;for(var e=0;e<this._bulletsT.length;++e)this._bulletsT[e].style.opacity=t?1:0},i.prototype.updateBottomDisp=function(t){this._showB=t;for(var e=0;e<this._bulletsB.length;++e)this._bulletsB[e].style.opacity=t?1:0};var l=function(t,e,n,o,i,l){return t>=n&&t<=n+i&&e>=o&&e<=o+l};i.prototype.getBulletAt=function(t,e){for(var n=0;n<this._bulletsT.length;++n)if(l(t,e,this._bulletsT[n].offsetLeft,this._bulletsT[n].offsetTop,this._bulletsT[n].clientWidth,this._bulletsT[n].clientHeight))return this._bulletsT[n];for(var n=0;n<this._bulletsB.length;++n)if(l(t,e,this._bulletsB[n].offsetLeft,this._bulletsB[n].offsetTop,this._bulletsB[n].clientWidth,this._bulletsB[n].clientHeight))return this._bulletsB[n];return null},i.prototype.handleMouseMove=function(t,e){var n=this.getBulletAt(t,e);n?(n.style.background="rgba(255, 255, 255, 0.4)",this._selBullet=n):this._selBullet&&(this._selBullet.style.background="none",this._selBullet=null)},i.prototype.handleClick=function(t,e){var n=this.getBulletAt(t,e)||this._selBullet;n&&(n.style.opacity=0,n._cancelled=!0,"function"==typeof this.opt.removeCallback&&this.opt.removeCallback(n._cmtID))},t.ctel=i;var r;r=t.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")};var s=videojs.getComponent("Component"),a=videojs.getComponent("Button"),u=videojs.getComponent("Popup"),p=videojs.getComponent("PopupButton"),c=function(t){function i(o,l){e(this,i);var r=n(this,t.call(this,o,l));return r.controlText(l&&l.controlText||""),r._isOn=!1,r}return o(i,t),i.prototype.buildCSSClass=function(){return"vjs-menu-object vjs-toggle-btn off "+t.prototype.buildCSSClass.call(this)},i.prototype.manualToggle=function(){this._isOn=!this._isOn,this._isOn?(this.el_.classList.remove("off"),this.el_.classList.add("on")):(this.el_.classList.remove("on"),this.el_.classList.add("off"))},i.prototype.handleClick=function(){this.manualToggle(),this.trigger("toggle",this._isOn)},i}(a),h=function(t){function i(o,l){e(this,i);var r=n(this,t.call(this,o,l));return r}return o(i,t),i.prototype.createEl=function(){var e=t.prototype.createEl.call(this,"div",{className:"vjs-cmtctrlpanel vjs-control"}),n=document.createElement("div"),o=document.createElement("div");o.classList.add("vjs-menu-object"),o.textContent="弹幕颜色",n.appendChild(o);var i=document.createElement("button");i.classList.add("vjs-menu-object");new jscolor(i,{container:n,value:"FFFFFF",mode:"HS",position:"left",hash:!0,width:120,height:80,shadow:!1,backgroundColor:"transparent",borderWidth:0});this._picker=i,n.appendChild(i),e.appendChild(n);var l=document.createElement("div"),s=document.createElement("div");s.classList.add("vjs-menu-object"),s.textContent="弹幕位置",l.appendChild(s);var a=new c;a.addClass("vjs-toggle-btn-send"),a.on("toggle",function(t){return function(e,n){t._sendAsBottom=n}}(this)),this._sendAsBottom=!1,l.appendChild(a.el()),e.appendChild(l);var u=document.createElement("div"),p=document.createElement("div");p.classList.add("vjs-menu-object"),p.textContent="显示顶端",u.appendChild(p);var h=new c;h.on("toggle",function(t){return function(e,n){"function"==typeof t.updateTopDisp&&t.updateTopDisp(n)}}(this)),h.manualToggle(),u.appendChild(h.el()),e.appendChild(u);var d=document.createElement("div"),f=document.createElement("div");f.classList.add("vjs-menu-object"),f.textContent="显示底部",d.appendChild(f);var m=new c;m.on("toggle",function(t){return function(e,n){"function"==typeof t.updateBottomDisp&&t.updateBottomDisp(n)}}(this)),m.manualToggle(),d.appendChild(m.el()),e.appendChild(d);var g=document.createElement("div"),y=document.createElement("div");y.classList.add("vjs-menu-object"),y.textContent="弹幕过滤",g.appendChild(y);var v=new c;v.addClass("vjs-toggle-btn-filtr"),v.on("toggle",function(t,e){if(!t.target.classList.contains("waiting")){t.target.classList.add("waiting");var n=r();n.onreadystatechange=function(t){return function(){4==n.readyState&&200==n.status&&t.classList.remove("waiting")}}(t.target),n.open("POST","http://127.0.0.1:6033/set_filtration/"+(e?"1":"0"),!0),n.send()}}),g.appendChild(v.el()),e.appendChild(g);var _=r();return _.onreadystatechange=function(){if(4==_.readyState&&200==_.status){var t=parseInt(_.responseText);1==t&&v.manualToggle()}},_.open("GET","http://127.0.0.1:6033/get_filtration",!0),_.send(),e},i}(s),d=function(t){function i(o,l){e(this,i);var r=n(this,t.call(this,o,l));return r}return o(i,t),i.prototype.createPopup=function(){var t=new u(this,{contentElType:"div"});t.el().style.height="auto";var e=new h;return t.addItem(e),this.panel=e,t},i.prototype.buildCSSClass=function(){return"vjs-cmt-popupbtn "+t.prototype.buildCSSClass.call(this)},i}(p);t.commentingPlugin=function(e){this.on("loadeddata",function(n){var o=r(),l=this;o.onreadystatechange=function(){if(4==o.readyState&&200==o.status){var n=io("http://127.0.0.1:6033/");n.on("unauthorized",function(){t.location.href=t.location.href}),n.on("comment",function(t){var e=t.attr.lastIndexOf(";"),n=t.attr.substring(0,e),o=t.attr.substring(e+1);"t"===o?player.ctel.emitTop(t.id,t.text,n):"b"===o&&player.ctel.emitBottom(t.id,t.text,n)});var r=document.getElementsByClassName("vjs-control-bar")[0].clientHeight;player.ctel=new i({width:player.el().offsetWidth,height:player.el().offsetHeight-r,removeCallback:function(t){n.emit("overrule",t)},timeoutCallback:function(t){n.emit("approve",t)}});var s=function(t,e,n){return function(){e.updateSize(player.el().offsetWidth,player.el().offsetHeight-(t.userActive()||t.paused()?n:0))}}(player,player.ctel,r);if(player.on("resize",s),player.on("fullscreenchange",function(){setTimeout(s,500)}),player.on("useractive",s),player.on("userinactive",s),player.addChild({name:function(){return"CommentingOverlay"},el:function(){return player.ctel.getEl()}},0),e.isModerator){var u=player.el().childNodes[0];"VIDEO"!==u.tagName.toUpperCase()&&document.getElementsByTagName("video")[0],player.on("mousemove",function(t,e,n){return function(t){e.handleMouseMove(t.offsetX,t.offsetY)}}(u,player.ctel,player.ctel.getEl())),player.on("click",function(t,e,n){return function(t){e.handleClick(t.offsetX,t.offsetY)}}(u,player.ctel,player.ctel.getEl())),player.on("pause",function(){this.play()})}if(document.getElementsByClassName("vjs-captions-button")[0].style.display="none",e.isModerator)return;var p=document.getElementsByClassName("vjs-fullscreen-control")[0],c=document.createElement("input");c.classList.add("vjs-cmtinput"),c.setAttribute("placeholder","在此输入弹幕~"),c.setAttribute("maxlength","140"),l.controlBar.addChild(c),player.controlBar.el().insertBefore(c,p);var h=new a;h.addClass("vjs-icon-circle-inner-circle"),h.el().setAttribute("title","发送"),player.controlBar.el().insertBefore(h.el(),p),c.addEventListener("keypress",function(t){return function(e){13==e.keyCode&&t.click()}}(h.el()));var f=new d(l);f.addClass("vjs-icon-subtitles"),f.el().setAttribute("title","弹幕设置"),player.controlBar.el().insertBefore(f.el(),p),f.panel.updateTopDisp=function(t){return function(e){t.updateTopDisp(e)}}(player.ctel),f.panel.updateBottomDisp=function(t){return function(e){t.updateBottomDisp(e)}}(player.ctel);var m=document.getElementsByClassName("vjs-cmt-popupbtn")[0],g=m.childNodes[0];g.classList.add("vjs-cmt-menu"),m.addEventListener("mouseenter",function(t){return function(e){clearTimeout(t.timer),t.style.display="block"}}(g)),m.addEventListener("mouseleave",function(t){return function(e){clearTimeout(t.timer),t.timer=setTimeout(function(){t.style.display="none",t.timer=null},360)}}(g)),h.on("click",function(t,e){return function(){var o=t._picker.textContent+";"+(t._sendAsBottom?"b":"t"),i=e.value;0!==i.trim().length&&(e.setAttribute("disabled",""),n.emit("pop",i,o,function(t){return function(){t.value="",setTimeout(function(){t.removeAttribute("disabled")},5e3)}}(e)))}}(f.panel,c))}},o.open("GET","http://127.0.0.1:6033/get_filtration",!0),o.send()})}}(window);
